#!/bin/bash

DB_FILE="storage.db"

# –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
# –°–º–æ—Ç—Ä–∏ –∑–∞–¥–∞–Ω–∏—è —Ç—É—Ç–∞:   https://docs.google.com/document/d/1HTJQ8QaDV1WNj_JcSdu62ZJJvmGZMzyCKzePJ7Nm7Tw/edit?usp=sharing
if [[ ! -f "$DB_FILE" ]]; then
    echo "üìÇ –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '$DB_FILE' –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é..."
    sqlite3 "$DB_FILE" "" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö."; exit 1; }
else
    echo "üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö '$DB_FILE'"
fi

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL —Å–∫—Ä–∏–ø—Ç–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü + –≤—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö)
sqlite3 "$DB_FILE" <<'EOF'
-- ========== –°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶ ==========

CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT NOT NULL UNIQUE,
    pass_hash BLOB NOT NULL,
    oauth_id TEXT,
	is_oauth BOOLEAN DEFAULT FALSE,
    total_attempts INTEGER DEFAULT 0,
    pass_levels INTEGER DEFAULT 0
);

CREATE INDEX IF NOT EXISTS idx_email ON users (email);

CREATE TABLE IF NOT EXISTS apps (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    secret TEXT NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS levels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    expected_input TEXT,
    start_input TEXT
);

CREATE TABLE IF NOT EXISTS hints (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    level_id INTEGER NOT NULL REFERENCES levels(id) ON DELETE CASCADE,
    hint_text TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS user_levels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    level_id INTEGER REFERENCES levels(id) ON DELETE CASCADE,
    is_completed BOOLEAN DEFAULT FALSE,
    last_input TEXT,
    attempt_response TEXT,
    attempts INTEGER DEFAULT 0
);

-- ========== –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –£–†–û–í–ù–ï–ô ==========

INSERT INTO levels (id, name, description, expected_input) VALUES
(0, '–ù–∞—á–∞–ª–æ', '–í—ã ‚Äî —Ö–∞–∫–µ—Ä-–Ω–æ–≤–∏—á–æ–∫, –Ω–∞–Ω—è—Ç—ã–π —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑—á–∏–∫–æ–º.
–í–∞—à–∞ —Ü–µ–ª—å ‚Äî –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∏–ª—å–Ω–µ–µ –Ω–∞–≤—Ä–µ–¥–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏-–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—É. 
–°–Ω–∞—á–∞–ª–∞ –≤—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ —É—è–∑–≤–∏–º—ã–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∞
–∑–∞—Ç–µ–º –ø–æ–¥–æ—Ä–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –ü–û —á–µ—Ä–µ–∑ —Å–∞–º–æ–ø–∏—Å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ –ø–∏—Ç–æ–Ω–µ.
–ö–∞–∂–¥–æ–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –≤–∞—Å –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É —Ö–∞–æ—Å—É.', ''),

(1, '–ö—Ç–æ –æ–Ω–∏ —Ç–∞–∫–∏–µ?', '–ú—ã –∑–Ω–∞–µ–º, —á—Ç–æ –Ω–∞—à –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç —Ö–æ—Å—Ç–∏—Ç —Å–≤–æ–π —Å–µ—Ä–≤–∏—Å –Ω–∞ —Å–∞–π—Ç–µ —Å –¥–æ–º–µ–Ω–æ–º /hosting.
–î–∞–≤–∞–π —É–∑–Ω–∞–µ–º –æ–± —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –±–æ–ª—å—à–µ, "–¥–µ—Ä–Ω—É–≤" —ç–Ω–¥–ø–æ–∏–Ω—Ç /about —Å –ø–æ–º–æ—â—å—é curl.', 'curl -X GET localhost:9086/about'),

(2, '–£ –Ω–∏—Ö –Ω–µ –∑–∞—â–∏—â–µ–Ω —Å–µ—Ä–≤–µ—Ä', '–£–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –æ–Ω–∏ –∑–∞–±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–µ–π—à–∏–µ —Å—Ö–µ–º—ã –∑–∞—â–∏—Ç—ã. –ú—ã —É–∑–Ω–∞–ª–∏ —Å–ª–µ–¥—É—é—â–µ–µ –æ–± –∏—Ö —Å–∏—Å—Ç–µ–º–µ:
admin@yandex.ru -> –ø–æ—á—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –¥–∞—à–±–æ—Ä–¥—ã
localhost:9086/db/about -> —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ö–µ–º–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 
localhost:9086/files -> —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–∏—Å—Ç–µ–º–µ
localhost:9086/login -> —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —É–∑–Ω–∞—Ç—å –∏—Ö –ë–î, –Ω–∞–≤–µ—Ä–Ω–æ–µ —Å—Ç–æ–∏—Ç –∑–∞—Ö–æ–¥–∏—Ç—å –ø–æ–¥ –∞–¥–º–∏–Ω–æ–º:', 'curl -X GET localhost:9086/db/about?user=admin'),

(3, '–ë—Ä—É—Ç—Ñ–æ—Ä—Å', '–•–º, –ø–æ—Ö–æ–∂–µ –Ω—É–∂–Ω–æ –æ–±–ª–∞–¥–∞—Ç—å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ë–î. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Ç–æ–≥–¥–∞
–∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –ø–æ–¥ –∞–¥–º–∏–Ω–æ–º, –Ω–æ –Ω—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å. –†–∞–∑ —É –Ω–∏—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∑–∞—â–∏—Ç–∞, —Ç–æ –∏ –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º,
–Ω–∞–ø—Ä–∏–º–µ—Ä 5-—Ç–∏ –∑–Ω–∞—á–Ω—ã–π.', 'curl -X POST http://localhost:9086/login -d "user=admin&password=12345"'),

(4, '–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞', '–ê —á—Ç–æ –µ—Å–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ö —Ñ–∞–π–ª—ã –Ω–∞ —Å–∏—Å—Ç–µ–º–µ. –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º —ç—Ç–æ, –æ—Ç–ø—Ä–∞–≤–∏–≤ query –∑–∞–ø—Ä–æ—Å —Å –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–æ–≤ –≤ UNIX —Å–∏—Å—Ç–µ–º–∞—Ö.', 'curl -X POST http://localhost:9086/files -d "cmd=ls"'),

(5, '–î—ã—Ä—è–≤–∞—è —Å–∏—Å—Ç–µ–º–∞', '–°—Ä–∞–±–æ—Ç–∞–ª–æ. –ú—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã: main.go, db.go, db.sql
–î–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º —Å—Ö–µ–º—É –ë–î, –ø—Ä–æ—Å—Ç–æ "–∫–∞—Ç–Ω—É–≤" –µ–µ.', 'curl -X POST http://localhost:9086/files -d "cmd=cat db.sql"'),

(6, '–ê–ó–´ SQL', '–ß—Ç–æ –∂, –º—ã –ø–æ–ª—É—á–∏–ª–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
- –£ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã users
–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ä—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–≤ SQL –∏–Ω—ä–µ–∫—Ü–∏—é.
–ú—ã —É–∑–Ω–∞–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ db.go, —á—Ç–æ —Ç–∞–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫–æ–π –∫–æ–¥:
username = input("Username: ")
query = "SELECT * FROM users WHERE username = ''{username}''"', ''' OR ''a'' = ''a'''),

(7, '–í –ø–æ–∏—Å–∫–∞—Ö –ø–∞—Ä–æ–ª—è', '–ß—Ç–æ –∂. –ú—ã —É–∑–Ω–∞–ª–∏, —á—Ç–æ –≤ —Å–∏—Å—Ç–µ–º–µ –µ—Å—Ç—å —Ä—É—Ç —é–∑–µ—Ä. –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –ø–∞—Ä–æ–ª—å. –ù–æ –¥–∞–≤–∞–π —Å—Ä–∞–∑—É —É–∑–Ω–∞–µ–º –ø–∞—Ä–æ–ª–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ò–∑ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞ –º—ã –≤–∏–¥–∏–º, —á—Ç–æ –≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫–∞—è —Å—Ç—Ä–æ—á–∫–∞:
SELECT name, email FROM clients WHERE name LIKE ''%$search%''.
–î–∞–≤–∞–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—É password, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–∞—Ä–æ–ª–∏.', ''' UNION SELECT password FROM users --'),

(8, '–î–µ–ª–∞–π –≥—Ä—è–∑—å', '–ê —Ç–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ —É—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π —Ö–∞–æ—Å –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –î–∞–≤–∞–π –¥—Ä–æ–ø–Ω–µ–º —Ç–∞–±–ª–∏—Ü—É –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ë–æ–ª—å—à–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –æ–Ω–∏ –Ω–µ –¥–µ–ª–∞—é—Ç —Å–Ω–∞–ø—à–æ—Ç—ã –∏—Ö –ë–î. –ë–µ—Ä–µ–º —Ç–æ—Ç –∂–µ –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏ –≤–∏–¥–∏–º: INSERT INTO feedback (text) VALUES (''$comment'')', '''; DROP TABLE users;--'),

(9, 'Stack Overflow', '–ù—É –¥–∞–≤–∞–π –Ω–∞–ø–∏—à–µ–º –∫–æ–¥. –î–∞–≤–∞–π —Å–ª–æ–º–∞–µ–º –∏—Ö –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä, —Å–¥–µ–ª–∞–≤ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–µ–∫–∞. –ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∫—É—Ä—Å–∏–µ–π –≤ –ø–∏—Ç–æ–Ω–µ.', 'def f(): f()\nf()'),

(10, 'OOM', '–ê —Ç–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω–∏–º –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–∞–º—è—Ç—å –∏ –∫—Ä–∞—à–Ω–µ–º –≤—Å—é —Å–∏—Å—Ç–µ–º—É. –î–∞–≤–∞–π —Ç–∞–∫–∂–µ –Ω–∞–ø–∏—à–µ–º —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–æ–≤–µ—Ç Memory Error.', 'a = []\nwhile True: a.append(''X''*10**6)');

-- ========== –ü–û–î–°–ö–ê–ó–ö–ò –î–õ–Ø –£–†–û–í–ù–ï–ô ==========

INSERT INTO hints (level_id, hint_text) VALUES
(1, '–ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å curl'),
(1, '-X GET –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞'),

(2, '–ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å curl'),
(2, '-X GET –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞'),
(2, '–ò—Å–ø–æ–ª—å–∑—É–π ? –¥–ª—è query'),

(3, '-X POST –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞'),
(3, '–ò—Å–ø–æ–ª—å–∑—É–π -d –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ form'),
(3, '& –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤'),
(3, '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã admin, password'),

(4, '-X POST –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞'),
(4, '–ò—Å–ø–æ–ª—å–∑—É–π ? –¥–ª—è query'),
(4, '–ò—Å–ø–æ–ª—å–∑—É–π ls'),

(5, '-X POST –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞'),
(5, '–ò—Å–ø–æ–ª—å–∑—É–π ? –¥–ª—è query'),
(5, '–ò—Å–ø–æ–ª—å–∑—É–π cat'),

(6, '–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é OR'),
(6, '–ü–æ–ø—Ä–æ–±—É–π —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–ª–æ–≤–∞'),

(7, '–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é UNION SELECT'),
(7, '–ò—Å–ø–æ–ª—å–∑—É–π -- –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'),

(8, '–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é DROP TABLE'),
(8, '–ò—Å–ø–æ–ª—å–∑—É–π -- –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'),

(9, '–ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∫—É—Ä—Å–∏—é'),
(9, '–ü—É—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç —Å–∞–º–∞ —Å–µ–±—è'),

(10, '–î–∞–≤–∞–π —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–æ–≤'),
(10, '–î–∞–≤–∞–π —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫');

EOF

echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞."

